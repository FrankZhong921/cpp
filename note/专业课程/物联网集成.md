# 物联网集成

## 使用协议对接平台

​	可以使用HTTP、MQTT和CoAP协议对接平台，但目前阿里云物联网平台中HTTP和CoAP只支持单纯数据上报的应用场景，也就是说智能通过HTTP和Coap往平台上发送数据，**适用于远程监控数据的应用**，例如，可以 DIY 个温湿度计，把家里的温湿度数据上传阿里云，可以在 WEB 或 是在 APP 上查看，又或者是智能农业大棚中，采集监测各种温湿度，一氧化碳，二氧化碳，光强度等等数据并上传监控。

​	当我们需要上行数据又**下行数据**时，就需要适用MQTT协议

## MQTT协议

- MQTT协议时**基于二进制Topic订阅关系的发布与推送**，物联网平台服务器全权负责接收**发布**与**推送订阅**。

- 发布与推送的区别：推送有明确的发布对象

- MQTT-3.1.1标准协议中定义了MQTT的14个报文

  ![image-20210510141751219](C:\Users\921-\AppData\Roaming\Typora\typora-user-images\image-20210510141751219.png)

- 报文组成： 固定报头（2）、可变报头以及负载

- QoS(Quality of Service 服务质量)

  ![image-20210510142112314](C:\Users\921-\AppData\Roaming\Typora\typora-user-images\image-20210510142112314.png)

  1. Qos0：发布消息而不管对方是否收到
  2. Qos1：发布消息直到接收到确认
  3. Qos2：发送端发布消息直到收到确认，平台再发送一次是否确认收到，等待确认，若没有收到则再重传

  **简单地讲：0，1，2代表分别收到几次确认**

- 报文格式：

  ​	![image-20210510143712851](C:\Users\921-\AppData\Roaming\Typora\typora-user-images\image-20210510143712851.png)

  1. 其中报文类型即为14种报文对应的编码 0x1~0xE

  2. 对于指定控制报文类型的标志位，除了PUBLISH报文，其它报文的四个位都固定，而PUBLISH报文的Bit3,2,1,0可以用来控制Qos级别。

  3. 剩余长度：可变报头+负载的长度，最少最用**1个字节**，最多占用**4个字节**。

     一个字节包含8个位，分别时*Bit0~Bit7*,**在MQTT中都是无符号的**，也就是8位代表范围0~255，**但是MQTT把Bit7当作一个进位标志，Bit0~6表示数值**，所以一个字节表示0~127



- MQTT协议交互时必须先发送CONNECT报文，且发送之前要先成功建立起阿里云的TCP连接。

  1. **CONNECT报文的作用时配置功能和提交信息，配置功能的任务有可变包头担任，提交信息的任务由负载部分担任**
  2. CONNECT报文固定报头的第一字节0x10，可变报头长度时固定的，占用10字节（MQTT + 长度）
  3. 报文中每个字符串前要加两个字节，描述该字符串的长度。

  ![image-20210510152536086](C:\Users\921-\AppData\Roaming\Typora\typora-user-images\image-20210510152536086.png)

  

  ## 阿里云物联网平台

  - **三元组：产品密钥 ， 设备名称 ， 设备密钥** 

    密钥都由阿里云分配，同一产品下设备名称不能重复

  