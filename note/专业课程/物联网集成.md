# 物联网集成

## 云平台

物联网平台作为承上启下的中间部分，向应用服务器开放API接口，向各种协议的设备提供API对接。

- **产品模型**是用来描述设备能力的文件，通过JSON的格式定义了设备的基本属性、上报数据和下发命令的消息格式。定义产品模型，即在物联网平台构建一款设备的抽象模型，使平台理解该款设备支持的属性信息。
- **编解码插件**主要根据设备上报数据的格式来判断是否需要开发。**如果设备上报的“数据格式”为“二进制码流”，则该产品下需要进行编解码插件开发；如果“数据格式”为“JSON”，则该产品下不需要进行编解码插件开发**。完成二进制格式和JSON格式相互转换的。它将设备上报的二进制数据解码为JSON格式供应用服务器“阅读”，将应用服务器下行的JSON格式命令编码为二进制格式数据供终端设备（UE）“理解执行”。

总的来说，云平台接收设备的上报信息和应用的下发信息，如果信息是二进制的，我们通过编解码插件进行解码。由于我们使用json格式对产品的功能（他们称为服务）、属性进行描述，因此可以方便地读出上报信息和下发信息，并且我们描述产品json的格式，描述的数据包的有效荷载如何解读，云平台还会用CoAP等协议对其进行封装。

## 产品开发流程

![image-20210616122321229](C:\Users\921-\AppData\Roaming\Typora\typora-user-images\image-20210616122321229.png)

- 创建产品
- 模型定义
- 开发插件
- 在线调试



## AT指令

- AT指令是应用于终端设备与PC应用之间连接与通信的指令

- 端到端开发：终端侧开发和应用服务器侧开发

  - 终端侧：硬件PCB设计、终端业务程序开发
  - 应用服务器侧开发：Profile文件开发、编解码库开发等

  <img src="E:\cpp\note\note_picture\image-20210617123105422.png" alt="image-20210617123105422" style="zoom:80%;" />

<img src="E:\cpp\note\note_picture\image-20210617123151600.png" alt="image-20210617123151600" style="zoom:80%;" />

- 常用指令：

  <img src="E:\cpp\note\note_picture\image-20210617150107416.png" alt="image-20210617150107416" style="zoom:50%;" />

  - AT+CGSN=1	（查询模块序列号，会返回IMEI国际移动设备标识序列号）

  - AT+CEREG      （通过不同的设置可以上报EPS注册状态、位置区码、小区ID、服务小区等，通常情况下只需要设置为自动上报EPS注册状态。）

    AT+CEREG=1	查询EPS注册状态

  - AT+CSCON=1      （查询终端与基站连接状态）

  - AT+CGPADDR =0       （查询核心网给终端分配的IP地址，它是通过NAT方式访问外部网络，对上行数据，NAT负责将UE的内部地址转换为公网地址，对下行数据则相反）

## 模块入网

1. 查询IMEI号，AT+CGSN=1，然后在云平台上使用IMEI号注册设备，刚注册完设备状态为未激活。

2. 配置 NB-IoT 模组入网：

   - 华为云 上的物联网平台 IP 地址为：119.3.250.80，端口号为：5683

     AT+NCDP=119.3.250.80,5683

   - 打开射频模块，AT+CFUN=1

   - AT+CFUN=1，检查NB-IoT模组网络附着状态

3. 上报数据：

   AT+NMGS=5,00193C0064，00193C0064是我们之前定义的终端上报的报文，包含温度湿度光强

   在云平台上查看设备，可以看到添加的设备状态为已在线

4. 命令响应：

   AT+NNMI=1，开启下行数据回显功能，云平台发送开关命令时，LiteOS收到信息，命令的码流，+NNMI：0100014F4E，其中4F4E代表“ON”

## BearPi操作系统编程



## 使用协议对接平台

​	可以使用HTTP、MQTT和CoAP协议对接平台，但目前阿里云物联网平台中HTTP和CoAP只支持单纯数据上报的应用场景，也就是说智能通过HTTP和Coap往平台上发送数据，**适用于远程监控数据的应用**，例如，可以 DIY 个温湿度计，把家里的温湿度数据上传阿里云，可以在 WEB 或 是在 APP 上查看，又或者是智能农业大棚中，采集监测各种温湿度，一氧化碳，二氧化碳，光强度等等数据并上传监控。

​	当我们需要上行数据又**下行数据**时，就需要适用MQTT协议

### MQTT协议

- MQTT协议时**基于二进制Topic订阅关系的发布与推送**，物联网平台服务器全权负责接收**发布**与**推送订阅**。

- 发布与推送的区别：推送有明确的发布对象

- MQTT-3.1.1标准协议中定义了MQTT的14个报文

  ![image-20210510141751219](E:\cpp\note\note_picture\image-20210510141751219.png)

- 报文组成： 固定报头（2）、可变报头以及负载

- QoS(Quality of Service 服务质量)

  ![image-20210510142112314](E:\cpp\note\note_picture\image-20210510142112314.png)

  1. Qos0：发布消息而不管对方是否收到
  2. Qos1：发布消息直到接收到确认
  3. Qos2：发送端发布消息直到收到确认，平台再发送一次是否确认收到，等待确认，若没有收到则再重传

  **简单地讲：0，1，2代表分别收到几次确认**

- 报文格式：

  ​	![image-20210510143712851](E:\cpp\note\note_picture\image-20210510143712851.png)

  1. 其中报文类型即为14种报文对应的编码 0x1~0xE

  2. 对于指定控制报文类型的标志位，除了PUBLISH报文，其它报文的四个位都固定，而PUBLISH报文的Bit3,2,1,0可以用来控制Qos级别。

  3. 剩余长度：可变报头+负载的长度，最少最用**1个字节**，最多占用**4个字节**。

     一个字节包含8个位，分别时*Bit0~Bit7*,**在MQTT中都是无符号的**，也就是8位代表范围0~255，**但是MQTT把Bit7当作一个进位标志，Bit0~6表示数值**，所以一个字节表示0~127



- MQTT协议交互时必须先发送CONNECT报文，且发送之前要先成功建立起阿里云的TCP连接。

  1. **CONNECT报文的作用时配置功能和提交信息，配置功能的任务有可变包头担任，提交信息的任务由负载部分担任**
  2. CONNECT报文固定报头的第一字节0x10，可变报头长度时固定的，占用10字节（MQTT + 长度）
  3. 报文中每个字符串前要加两个字节，描述该字符串的长度。

  ![image-20210510152536086](E:\cpp\note\note_picture\image-20210510152536086.png)

  

  ## 阿里云物联网平台

  - **三元组：产品密钥 ， 设备名称 ， 设备密钥** 

    密钥都由阿里云分配，同一产品下设备名称不能重复






### CoAP协议

CoAP协议报文：	header + payload，头部和数据中间用个**单字节0xFF**隔开

目前云平台只支持　上行传输

- 报文组成：

  - Ver：版本号

  - Ｔ：报文类型，有四种

    ​	CON报文(00)，NON报文(01)，ACK报文(10)，RST报文(11)

  - TKL：CoAP标识符长度

  - Code：占一个字节，**高三位.低五位**；类似HTTP，支持GET(), POST,PUT,DELETE，在响应报文中作为响应码，Created，Delete，Valid，Changed，Content，Bad request

  - Message ID：标识消息

  - Token( if any, TKL bytes)：可在ACK中写入缺失或者错误的Message ID

  - Options( if any )